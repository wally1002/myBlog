<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Move the turtle - Interstellar</title>
<meta name="description" content="Move the turtle">


  <meta name="author" content="Sankeerth">
  
  <meta property="article:author" content="Sankeerth">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Interstellar">
<meta property="og:title" content="Move the turtle">
<meta property="og:url" content="wally1002.github.io/myBlog/tech/Move-the-turtle/">


  <meta property="og:description" content="Move the turtle">





  <meta name="twitter:site" content="@wally1002">
  <meta name="twitter:title" content="Move the turtle">
  <meta name="twitter:description" content="Move the turtle">
  <meta name="twitter:url" content="wally1002.github.io/myBlog/tech/Move-the-turtle/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2021-07-12T00:00:00+05:30">





  

  


<link rel="canonical" href="wally1002.github.io/myBlog/tech/Move-the-turtle/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Sankeerth",
      "url": "wally1002.github.io/myBlog/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/myBlog/feed.xml" type="application/atom+xml" rel="alternate" title="Interstellar Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/myBlog/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/myBlog/"><img src="/myBlog/assets/images/bat.jpg" alt="Interstellar"></a>
        
        <a class="site-title" href="/myBlog/">
          Interstellar
          <span class="site-subtitle">Travel Ever</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/myBlog/about">About</a>
            </li><li class="masthead__menu-item">
              <a href="/myBlog/tech/">Tech</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Sankeerth</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Final year Undergrad.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Guwahati</span>
        </li>
      

      
        
          
        
          
        
          
        
          
        
          
        
          
        
      

      

      
        <li>
          <a href="mailto:sankeerthreddy1002@gmail.com">
            <meta itemprop="email" content="sankeerthreddy1002@gmail.com" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span>
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Move the turtle">
    <meta itemprop="description" content="Move the turtle">
    <meta itemprop="datePublished" content="2021-07-12T00:00:00+05:30">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Move the turtle
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          12 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <h2 id="move-the-turtle">Move the turtle</h2>

<p>In the previous post we controlled the turtle using our keys, but we may want to automate this process by writing a piece of code which tells the turtle to move in a specified manner. There are 2 ways of controlling it using code. One is through command line using <code class="language-plaintext highlighter-rouge">rostopic pub</code> and other is using a python/c++ code. We will start with the command line one.</p>

<h3 id="rostopic-pub-through-command-line">Rostopic pub through command line</h3>

<p>We have already seen <code class="language-plaintext highlighter-rouge">rostopic list</code>, <code class="language-plaintext highlighter-rouge">rostopic info</code>, <code class="language-plaintext highlighter-rouge">rostopic echo</code>. Adding to that stack of commands will be <code class="language-plaintext highlighter-rouge">rostopic pub</code>. This command helps us publish the data onto a rostopic from terminal itself. Remember the rostopic which the <code class="language-plaintext highlighter-rouge">teleop</code> node published in the previous tutorial? It’s <code class="language-plaintext highlighter-rouge">/turtle1/cmd_vel</code>. We will now publish a message directly to this topic from command line.</p>

<p><code class="language-plaintext highlighter-rouge">roscore</code></p>

<p>New terminal -</p>

<p><code class="language-plaintext highlighter-rouge">rosrun turtlesim turtlesim_node</code></p>

<p>A small trick is to use tab auto complete in terminal. Type something incompletely and press tab key once, If an unambiguous choice is present it will fill it otherwise it doesn’t change anything. If you press the tab key twice you can see all the suggestions. This will be helpful in filling out the <code class="language-plaintext highlighter-rouge">rostopic pub</code> command. Whenever you see things filling out without me typing I’m using tab key to auto complete.</p>

<p><code class="language-plaintext highlighter-rouge">rostopic pub &lt;topic name&gt; &lt;message type&gt; &lt;message&gt;</code></p>

<p>Usually after filling out topic name press tab key twice. It will auto fill message type and message. Then edit the message to your requirements.</p>

<p><img src="https://github.com/wally1002/tutorials/blob/main/media/rostopic_pub_single.gif?raw=true" alt="rostopic_pub_single" /></p>

<p>Edit the linear velocities in x, y directions and observe. As you can see the turtle stopped after sometime, it’s because we only sent a single message. Some times we need to send messages continuously. This is where <code class="language-plaintext highlighter-rouge">-r</code> flag helps us. It means repeatedly. The command structure will be</p>

<p><code class="language-plaintext highlighter-rouge">rostopic pub -r &lt;frequency of messages&gt; &lt;topic name&gt; &lt;message type&gt; &lt;message&gt;</code></p>

<p><img src="https://github.com/wally1002/tutorials/blob/main/media/rostopic_pub_rec.gif?raw=true" alt="rostopic_pub_rec" /></p>

<p>In the GIF we are sending 1 message per second. We can increase the frequency if needed. This concludes discussion on rostopics. Now let’s move turtle to a given location.</p>

<h3 id="move-through-code">Move through Code</h3>

<p>Now we will write a python code encompassing all the ideas we discussed. I’m assuming little knowledge of python. First we need to create a file in the scripts directory of our tutorials package.</p>

<p><code class="language-plaintext highlighter-rouge">cd ~/catkin_ws/src/tutorials/scripts</code></p>

<p><code class="language-plaintext highlighter-rouge">touch control.py</code></p>

<p><code class="language-plaintext highlighter-rouge">chmod +x control.py</code></p>

<p>Now you can open the file and edit in your favourite editor. The last command makes your file executable so we can run it as a rosnode. I will paste the whole code here then dissect it to the bits.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span>
<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Twist</span>
<span class="kn">from</span> <span class="nn">turtlesim.msg</span> <span class="kn">import</span> <span class="n">Pose</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="nb">pow</span><span class="p">,</span> <span class="n">atan2</span><span class="p">,</span> <span class="n">sqrt</span>

<span class="k">class</span> <span class="nc">TurtleBot</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rospy</span><span class="p">.</span><span class="n">init_node</span><span class="p">(</span><span class="s">'turtlebot_controller'</span><span class="p">,</span> <span class="n">anonymous</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">velocity_publisher</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s">'/turtle1/cmd_vel'</span><span class="p">,</span> <span class="n">Twist</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">pose_subscriber</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s">'/turtle1/pose'</span><span class="p">,</span> <span class="n">Pose</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">update_pose</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">Pose</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Rate</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="s">"""Callback function which is called when a new message of type Pose is received by the 				 	   subscriber."""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">euclidean_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_pose</span><span class="p">):</span>
        <span class="s">"""Euclidean distance between current pose and the goal."""</span>
        <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">pow</span><span class="p">((</span><span class="n">goal_pose</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">x</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">((</span><span class="n">goal_pose</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">y</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">steering_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_pose</span><span class="p">):</span>
        <span class="s">"""Angle which the turtle needs to rotate to align with the goal position."""</span>
        <span class="k">return</span> <span class="n">atan2</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">goal_pose</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">x</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">linear_vel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_pose</span><span class="p">,</span> <span class="n">constant</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
        <span class="s">"""Velocity as a linear function of the distance to be moved. Velocity = K * Distance"""</span>
        <span class="k">return</span> <span class="n">constant</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">euclidean_distance</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">angular_vel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_pose</span><span class="p">,</span> <span class="n">constant</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
        <span class="s">"""Angular velocity at which the turtle has to rotate to align with goal position"""</span>
        <span class="k">return</span> <span class="n">constant</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">steering_angle</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">theta</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">move2goal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Moves the turtle to the goal."""</span>
        <span class="n">goal_pose</span> <span class="o">=</span> <span class="n">Pose</span><span class="p">()</span>

        <span class="n">goal_pose</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"Set your x goal: "</span><span class="p">)</span>
        <span class="n">goal_pose</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"Set your y goal: "</span><span class="p">)</span>

        <span class="n">distance_tolerance</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"Set your tolerance: "</span><span class="p">)</span>

        <span class="n">vel_msg</span> <span class="o">=</span> <span class="n">Twist</span><span class="p">()</span>

        <span class="k">while</span> <span class="bp">self</span><span class="p">.</span><span class="n">euclidean_distance</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">distance_tolerance</span><span class="p">:</span>
            
            <span class="n">vel_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">linear_vel</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">)</span>
            <span class="n">vel_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">vel_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="n">vel_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">vel_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">vel_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">angular_vel</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="p">.</span><span class="n">velocity_publisher</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">vel_msg</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="p">.</span><span class="n">rate</span><span class="p">.</span><span class="n">sleep</span><span class="p">()</span>
            
        <span class="n">vel_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vel_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">velocity_publisher</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">vel_msg</span><span class="p">)</span>
        <span class="n">rospy</span><span class="p">.</span><span class="n">spin</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">TurtleBot</span><span class="p">()</span>
        <span class="n">x</span><span class="p">.</span><span class="n">move2goal</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">rospy</span><span class="p">.</span><span class="n">ROSInterruptException</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div>

<p>Now let’s breakdown the code.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span></code></pre></div></div>

<p>Above line specifies the python interpreter version for the code.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#import libraries
</span><span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Twist</span>
<span class="kn">from</span> <span class="nn">turtlesim.msg</span> <span class="kn">import</span> <span class="n">Pose</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="nb">pow</span><span class="p">,</span> <span class="n">atan2</span><span class="p">,</span> <span class="n">sqrt</span>
</code></pre></div></div>

<p>rospy is python package for writing code we can connect to ros. geometry_msgs are msg class which contain several msgs. Twist is a velocity msg type containing 6 values which are 3 Linear velocities, 3 angular velocities. Pose message has x, y, theta with x axis, linear velocity, angular velocity. Rest are math functions for calculations.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TurtleBot</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Creates a node with name 'turtlebot_controller' and make sure it is a unique node (using 						anonymous=True).
</span>        <span class="n">rospy</span><span class="p">.</span><span class="n">init_node</span><span class="p">(</span><span class="s">'turtlebot_controller'</span><span class="p">,</span> <span class="n">anonymous</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c1"># Publisher which will publish to the topic '/turtle1/cmd_vel' of type Twist with a queue of 10 msgs.
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">velocity_publisher</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s">'/turtle1/cmd_vel'</span><span class="p">,</span> <span class="n">Twist</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># A subscriber to the topic '/turtle1/pose' with msg type Pose. self.update_pose is called when a 			    message of type Pose is received.
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">pose_subscriber</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s">'/turtle1/pose'</span><span class="p">,</span>
                                                <span class="n">Pose</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">update_pose</span><span class="p">)</span>
        <span class="c1"># set the pose variable
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">Pose</span><span class="p">()</span>
        <span class="c1"># set rospy rate which is used for specifing the publishing rate
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Rate</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div></div>

<p>Define a class for a turtle with all the functions needed. In the constructor(<code class="language-plaintext highlighter-rouge">__init__</code>) of the class we define our publishers and subscribers. First we initialise our node using <code class="language-plaintext highlighter-rouge">rospy.init_node</code> which gives our node a name and unique identifier using <code class="language-plaintext highlighter-rouge">anonymous</code> flag. Then we define our velocity publisher using <code class="language-plaintext highlighter-rouge">rospy.Publisher(&lt;topic name&gt;, &lt;msg type&gt;, queue_size=)</code>. Here our topic name is <code class="language-plaintext highlighter-rouge">/turtle1/cmd_vel</code> which has a msg type <code class="language-plaintext highlighter-rouge">Twist</code>(try to find out how?). They we define a pose subscriber using <code class="language-plaintext highlighter-rouge">rospy.Subscriber(&lt;topic name&gt;, &lt;msg type&gt;, &lt;callback function&gt;)</code>. Subscribers have a callback function which is called whenever we receive a new msg to the topic. We define a pose variable to store our pose value. rate stores the frequency at which we will publish our msg, this can be set using <code class="language-plaintext highlighter-rouge">rospy.Rate(&lt;value&gt;)</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">update_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="s">"""Callback function which is called when a new message of type Pose is received by the 				 	   subscriber."""</span>
    <span class="c1"># store the pose msg in pose variable
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">data</span>
    <span class="c1"># round of x, y to 4 decimal places
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</code></pre></div></div>

<p>The above function is the callback function for the subscriber we have written. It takes the data from the topic, It stores the data in pose variable, then rounds off x, y to 4 decimal places.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">euclidean_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_pose</span><span class="p">):</span>
    <span class="s">"""Euclidean distance between current pose and the goal."""</span>
    <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">pow</span><span class="p">((</span><span class="n">goal_pose</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">x</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">((</span><span class="n">goal_pose</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">y</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">steering_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_pose</span><span class="p">):</span>
    <span class="s">"""Angle which the turtle needs to rotate to align with the goal position."""</span>
    <span class="k">return</span> <span class="n">atan2</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">goal_pose</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">linear_vel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_pose</span><span class="p">,</span> <span class="n">constant</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
    <span class="s">"""Velocity as a linear function of the distance to be moved. Velocity = K * Distance"""</span>
    <span class="k">return</span> <span class="n">constant</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">euclidean_distance</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">angular_vel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_pose</span><span class="p">,</span> <span class="n">constant</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="s">"""Angular velocity at which the turtle has to rotate to align with goal position"""</span>
    <span class="k">return</span> <span class="n">constant</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">steering_angle</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">theta</span><span class="p">)</span>
</code></pre></div></div>

<p>Let’s look at an image first. In the image we can see a goal position in  a X-Y coordinate system. $\theta$ is the steering angle we calculate using the <code class="language-plaintext highlighter-rouge">steering_angle</code> function. The distance between turtle and goal position is calculated using the <code class="language-plaintext highlighter-rouge">euclidean_distance</code> function. It’s very simple math.</p>

<p><img src="https://github.com/wally1002/tutorials/blob/main/media/goal_turtle.png?raw=true" alt="goal_turtle" /></p>

<p>Now that we have established the variables we want to use to steer the turtle to the goal let’s use them. To control the turtle we used what’s called as a Proportional Controller. It will be of form $y = K_p * x$  where $y$ is the variable we want to control and $x$ is the variable we have. $K_p$ is the called the proportional gain. So here $x$ is $\theta$, $d$ for two $y$’s which are $V_x$ and $\omega_z$. This is really intuitive. Let’s say if we have a large steering angle then we may want to adjust it quickly, this is what the proportional controller does. If input is large then output is large and vice-versa. So the equations we have are</p>

<p>\(\begin{align*}
	V_x = K_{p1} * d \\
	\omega_x = K_{p2} * \theta \\
\end{align*}\)
The above $V_x$ and $\omega_z$ are calculated using <code class="language-plaintext highlighter-rouge">linear_vel</code> and <code class="language-plaintext highlighter-rouge">angular_vel</code> functions. Now that we have these values the only remaining step is publishing these values to the topic <code class="language-plaintext highlighter-rouge">/turtle1/cmd_vel</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">move2goal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">"""Moves the turtle to the goal."""</span>
    <span class="c1"># define a goal position msg
</span>    <span class="n">goal_pose</span> <span class="o">=</span> <span class="n">Pose</span><span class="p">()</span>

    <span class="c1"># Get the input from the user.
</span>    <span class="n">goal_pose</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"Set your x goal: "</span><span class="p">)</span>
    <span class="n">goal_pose</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"Set your y goal: "</span><span class="p">)</span>

    <span class="c1"># Please, insert a number slightly greater than 0 (e.g. 0.01).
</span>    <span class="n">distance_tolerance</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"Set your tolerance: "</span><span class="p">)</span>

    <span class="c1"># define a velocity msg which needs to be published
</span>    <span class="n">vel_msg</span> <span class="o">=</span> <span class="n">Twist</span><span class="p">()</span>

    <span class="c1"># If we are not within the distance tolerance limit then apply the controller. 
</span>    <span class="k">while</span> <span class="bp">self</span><span class="p">.</span><span class="n">euclidean_distance</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">distance_tolerance</span><span class="p">:</span>

        <span class="c1"># Porportional controller.
</span>        <span class="c1"># https://en.wikipedia.org/wiki/Proportional_control
</span>        
        <span class="c1"># Set the velocities calculated in the above functions. 
</span>
        <span class="c1"># Linear velocity in the x-axis.
</span>        <span class="n">vel_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">linear_vel</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">)</span>
        <span class="n">vel_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vel_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Angular velocity in the z-axis.
</span>        <span class="n">vel_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vel_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vel_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">angular_vel</span><span class="p">(</span><span class="n">goal_pose</span><span class="p">)</span>

        <span class="c1"># Publishing our vel_msg 
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">velocity_publisher</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">vel_msg</span><span class="p">)</span>

        <span class="c1"># Publish at the desired rate.
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">rate</span><span class="p">.</span><span class="n">sleep</span><span class="p">()</span>

    <span class="c1"># Stopping our robot after the movement is over.
</span>    <span class="n">vel_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">vel_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">velocity_publisher</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">vel_msg</span><span class="p">)</span>

    <span class="c1"># If we press control + C, the node will stop.
</span>    <span class="n">rospy</span><span class="p">.</span><span class="n">spin</span><span class="p">()</span>
</code></pre></div></div>

<p>The above function <code class="language-plaintext highlighter-rouge">move2goal</code> is the main piece of code which calls all the other functions and steers it to the goal. We take 3 inputs which are <code class="language-plaintext highlighter-rouge">x goal, y goal, tolerance</code>. Tolerance is the error which we can tolerate, so keep it’s value <code class="language-plaintext highlighter-rouge">&lt;0.3</code>(try other values and see what happens) . If our distance to the goal position is greater than tolerance we have to move, otherwise we break out of the while loop and stop our turtle. Now we will set the velocities $V_x$ and $\omega_z$ to the velocity msg. Then we will publish it using  <code class="language-plaintext highlighter-rouge">velocity_publisher.publish(vel_msg)</code>. The rate of publish is using <code class="language-plaintext highlighter-rouge">rate.sleep()</code> using the <code class="language-plaintext highlighter-rouge">rate</code> variable defined. After breaking out of the while loop we need to stop the turtle so we publish a zero velocity msg. <code class="language-plaintext highlighter-rouge">rospy.spin()</code> lets us terminate the program using <code class="language-plaintext highlighter-rouge">ctrl + C</code> in the terminal.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># this is our main function which will call the other functions. 
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Instantiate our Turtle class
</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">TurtleBot</span><span class="p">()</span>
        <span class="c1"># Give it a move goal command.
</span>        <span class="n">x</span><span class="p">.</span><span class="n">move2goal</span><span class="p">()</span>
    <span class="c1"># If there is an interruption pass it and continue. 
</span>    <span class="k">except</span> <span class="n">rospy</span><span class="p">.</span><span class="n">ROSInterruptException</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div>

<p>This above piece of code is where we call everything we written. So <code class="language-plaintext highlighter-rouge">if __name__ == '__main__':</code> executes our program. If you want to know more on this watch this <a href="https://www.youtube.com/watch?v=sugvnHA7ElY">video</a>. We instantiate our <code class="language-plaintext highlighter-rouge">TurtleBot</code> class then call the <code class="language-plaintext highlighter-rouge">move2goal</code> function.</p>

<p><img src="https://github.com/wally1002/tutorials/blob/main/media/move2goal.gif?raw=true" alt="move2goal" /></p>

<p>So that is it. This is how we can control a robot in simulator using code. I tried to split everything into modules and asses them individually. So if you have any doubts you can ping me anytime!.</p>


        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/myBlog/tags/#python" class="page__taxonomy-item" rel="tag">Python</a><span class="sep">, </span>
    
      <a href="/myBlog/tags/#robotics" class="page__taxonomy-item" rel="tag">Robotics</a><span class="sep">, </span>
    
      <a href="/myBlog/tags/#ros" class="page__taxonomy-item" rel="tag">ROS</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/myBlog/categories/#tech" class="page__taxonomy-item" rel="tag">tech</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2021-07-12T00:00:00+05:30">July 12, 2021</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?via=wally1002&text=Move+the+turtle%20wally1002.github.io%2FmyBlog%2Ftech%2FMove-the-turtle%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=wally1002.github.io%2FmyBlog%2Ftech%2FMove-the-turtle%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=wally1002.github.io%2FmyBlog%2Ftech%2FMove-the-turtle%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          
            
      </div>
    </div>
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    
      <li><a href="/myBlog/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 Sankeerth. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/myBlog/assets/js/main.min.js"></script>








<script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "all" } } }); </script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        processEscapes: true
      }
    });
  </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>

  </body>
</html>
